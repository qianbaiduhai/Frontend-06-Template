<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>地图编辑器</title>
        <style>
            :root {
                --cell-width: 7px;
                --cell-height: 7px;

                --theme-color: #9c9c9c;
            }
            #container {
                display: flex;
                flex-wrap: wrap;

                width: calc(var(--cell-width) * 100);
                height: calc(var(--cell-height) * 100);
                overflow: hidden;
                font-size: 0;
            }
            .cell {
                width: var(--cell-width);
                height: var(--cell-height);
                background: var(--theme-color);
            }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <button id="clear">清除</button>
    </body>
    <script>
        window.onload = () => {
            const $ = (props) => document.querySelector(props);
            const sleep = (timeout) => {
                new Promise((resolve) => {
                    setTimeout(() => {
                        resolve();
                    }, timeout);
                });
            };

            const MAP_DATA = 'MAP_DATA';
            const MAP_X = 100;
            const MAP_Y = 100;
            const COLOR_CONFIG = {
                1: '#fff',
                2: '#3f51b5',
                3: '#ff1100',
                4: '#000',
                5: '#FFEB3B',
            };

            const container = $('#container');

            const offlineData = localStorage.getItem(MAP_DATA);
            let mapData = offlineData ? JSON.parse(offlineData) : Array(MAP_X * MAP_Y).fill(0);

            let clear = false;
            let isMouseDown = false;
            let timeoutRecord = undefined;

            const renderMap = () => {
                container.innerText = '';

                for (let x = 0; x < MAP_X; x++) {
                    for (let y = 0; y < MAP_Y; y++) {
                        const index = x * MAP_X + y;
                        const element = mapData[index];

                        let cell = document.createElement('div');
                        cell.setAttribute('class', 'cell');

                        cell.style.setProperty('background', COLOR_CONFIG[element]);

                        const setOfflineMapData = () => {
                            timeoutRecord = setTimeout(() => {
                                localStorage.setItem(MAP_DATA, JSON.stringify(mapData));
                            }, 300);
                        };

                        cell.addEventListener('mouseover', () => {
                            if (isMouseDown) {
                                mapData[index] = clear ? 0 : 1;

                                cell.style.setProperty(
                                    'background',
                                    clear ? 'var(--theme-color)' : '#fff'
                                );
                                if (timeoutRecord) {
                                    clearTimeout(timeoutRecord);
                                    setOfflineMapData();
                                    return;
                                }
                                setOfflineMapData();
                            }
                        });

                        container.appendChild(cell);
                    }
                }
            };
            renderMap();

            document.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                clear = e.which === 3;
            });
            document.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });

            const clearButton = $('#clear');
            clearButton.addEventListener('click', () => {
                mapData = Array(MAP_X * MAP_Y).fill(0);
                localStorage.removeItem(MAP_DATA);
                renderMap();
            });

            path = (start, end) => {
                const queue = [start];

                console.time('path');
                const insert = async (x, y) => {
                    if (x < 0 || x > MAP_X) return;
                    if (y < 0 || y > MAP_Y) return;
                    if (mapData[x * MAP_X + y] !== 0) {
                        return;
                    }

                    mapData[x * MAP_X + y] = 2;
                    queue.push([x, y]);
                };

                while (queue.length) {
                    let [x, y] = queue.shift();
                    if (x === end[0] && y === end[1]) {
                        break;
                    }
                    insert(x + 1, y);
                    insert(x, y + 1);
                    insert(x - 1, y);
                    insert(x, y - 1);
                }

                console.timeEnd('path');
            };
        };
    </script>
</html>
